define(["jquery","bootstrap"],function(t){"use strict";t.fn.form=function(i,e,r){return r||"function"!=typeof e||(r=e),this.render=function(i,e){var r=this,o=t("<div class='row'>").appendTo(r);return i.submit||(i=t.extend({},i,{submit:{type:"submit",title:"Submit &raquo;"}})),function n(i,s){t.each(i,function(i,a){var u=s?s+"-"+i:i,h=r.getFieldValue(u,e);if("group"===a.type)n(a.values,u);else{var l,f={id:u,schema:a,value:"string"==typeof h?h.replace(/[&<>"'\/]/g,function(t){return{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"}[t]}):h,title:a.title};f.control=r.form.templates[a.type]||r.form.templates.text,f.$control=f.control(f),l=f.control.wrapped?t(r.form.templates.wrapper(f)).appendTo(o).find("#"+u):t(f.$control).appendTo(o),a.show_if&&r.on("input change",function(){l.closest(".form-group").parent()[r.getVisiblityCondition(a.show_if)?"show":"hide"]()})}})}(i),r.trigger("change")},this.set=function(i){var e=this;e.find("[name]").each(function(){var r=e.getFieldValue(this.name,i);"undefined"!=typeof r&&t(this).val(r).trigger("change")})},this.toJSON=function(){var i=this,e=i.serializeArray(),r={};return t.each(e,function(){var e=this.name.split("-"),o=r,n=null,s=null,a=this.value;try{a=-1===["object","boolean"].indexOf(typeof JSON.parse(a))?a:JSON.parse(a)}catch(u){}t.each(e,function(){s=this,n=o,o[this]||(o[this]={}),o=o[this]});var h=i.find("#"+this.name);h.attr("multiple")||"checkbox"===h.attr("type")?n[s].push?n[s].push(a):n[s]=[a]:n[s]=a}),r},this.validate=function(e){var r=this,o=this.toJSON();r.find(".form-group.has-error").removeClass("has-error").tooltip("destroy");var n=[];return function s(i,e){t.each(i,function(t,i){var a=e?e+"-"+t:t,u=r.getFieldValue(a,o);if("group"===i.type)s(i.values,a);else if(i.required&&!u){if(i.show_if)for(var h in i.show_if)if(!r.getVisiblityCondition(i.show_if))return!0;n.push(r.find("#"+a))}})}(i),n.length?setTimeout(function(){n.reverse().map(r.throwError)},150):e.call(this,o),!1},this.throwError=function(t,i){var e=t.focus().closest(".form-group").addClass("has-error");"string"==typeof i&&e.tooltip({title:i,trigger:"manual"}).tooltip("show")},this.throwErrors=function(t,i){for(var e in t)if(isNaN(t[e].length))this.throwErrors(t[e],(i?i+"-":"")+e);else for(var r=0;r<t[e].length;r++)this.throwError(this.find("#"+(i?i+"-":"")+e),t[e][r])},this.clear=function(){return this.off().find("*").remove(),this},this.getFieldValue=function(t,i){var e=t.split("-");return e.length>1?i?this.getFieldValue(e.slice(1).join("-"),i[e[0]]):void 0:i&&null!==i[t]?i[t]:void 0},this.getVisiblityCondition=function(t){return new Function("data","return "+t).call(this,this.toJSON())},this.clear().render(i,e).off("submit").on("submit",this.validate.bind(this,r))}});
