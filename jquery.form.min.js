define(["jquery","bootstrap"],function(t){"use strict";t.fn.form=function(e,i,r){r||"function"!=typeof i||(r=i),i||r||"function"!=typeof e||(r=e);var n=this;return n.render=function(e,i){n.schema=e,n.find("*").remove(),n.visiblityConditions=[];var r=t("<div class='row'>").appendTo(n);return function o(e,a){t.each(e,function(e,s){var l=a?a+"-"+e:e,u=n.getFieldValue(l,i);if("group"===s.type)o(s.values,l);else{var f,c={id:l,schema:s,value:"string"==typeof u?u.replace(/[&<>"'\/]/g,function(t){return{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"}[t]}):u,title:s.title};c.control=n.form.templates[s.type]||n.form.templates.text,c.$control=c.control(c),f=c.control.wrapped?t(n.form.templates.wrapper(c)).appendTo(r).find("#"+l):t(c.$control).appendTo(r),s.show_if&&n.visiblityConditions.push({show_if:s.show_if,$field:f.closest(".form-group").parent()})}})}(n.schema),n.trigger("change")},n.set=function(e){return n.find("[name]").each(function(){var i=n.getFieldValue(this.name,e);"undefined"!=typeof i&&t(this).val(i)}),n.trigger("change")},n.toJSON=function(){var e=n.serializeArray(),i={};return t.each(e,function(){var e=this.name.split("-"),r=i,o=null,a=null,s=this.value;try{s=-1===["object","boolean"].indexOf(typeof JSON.parse(s))?s:JSON.parse(s)}catch(l){}t.each(e,function(){a=this,o=r,r[this]||(r[this]={}),r=r[this]});var u=n.find("#"+this.name);u.attr("multiple")||"checkbox"===u.attr("type")?o[a].push?o[a].push(s):o[a]=[s]:o[a]=s}),i},n.handler=function(){n.find(".form-group.has-error").removeClass("has-error").tooltip("destroy");var t=n.schema,e=n.toJSON(),i=n.validate(t,e);return i.length?setTimeout(function(){i.reverse().map(n.throwError)},150):r.call(n,e),!1},n.validate=function(e,i){var r=[];return function o(e,a){t.each(e,function(t,e){var s=a?a+"-"+t:t,l=n.getFieldValue(s,i);if("group"===e.type)o(e.values,s);else if(e.required&&!l){if(e.show_if&&!n.getVisiblityCondition(e.show_if,i))return!0;r.push(n.find("#"+s))}})}(e),r},n.throwError=function(t,e){var i=t.focus().closest(".form-group").addClass("has-error");return"string"==typeof e&&i.tooltip({title:e,trigger:"manual"}).tooltip("show"),n},n.throwErrors=function(t,e){for(var i in t)if(isNaN(t[i].length))n.throwErrors(t[i],(e?e+"-":"")+i);else for(var r=0;r<t[i].length;r++)n.throwError(n.find("#"+(e?e+"-":"")+i),t[i][r]);return n},n.getFieldValue=function(t,e){var i=t.split("-");return i.length>1?e?n.getFieldValue(i.slice(1).join("-"),e[i[0]]):void 0:e&&null!==e[t]?e[t]:void 0},n.updateVisiblityState=function(){for(var t=n.toJSON(),e=0;e<n.visiblityConditions.length;e++){var i=n.visiblityConditions[e].$field,r=n.visiblityConditions[e].show_if;i[n.getVisiblityCondition(r,t)?"show":"hide"]()}return n},n.getVisiblityCondition=function(t,e){return new Function("data","return "+t).call(n,e)},n.render(e,i).off("submit",n.handler).on("submit",n.handler).off("input change",n.updateVisiblityState).on("input change",n.updateVisiblityState)}});
