define(["jquery","bootstrap"],function(t){"use strict";t.fn.form=function(i,e,n){return n||"function"!=typeof e||(n=e),this.render=function(i,e){var n=this,r=t("<div class='row'>").appendTo(n);return i.submit||(i=t.extend({},i,{submit:{type:"submit",title:"Submit"}})),function o(i,s){t.each(i,function(i,a){var u=s?s+"-"+i:i,h=n.getFieldValue(u,e);if("group"===a.type)o(a.values,u);else{var l,f={id:u,schema:a,value:"string"==typeof h?h.replace(/"/g,"&quot;"):h,title:a.title};f.control=n.form.templates[a.type](f),l=n.form.templates[a.type].wrapped?t(n.form.templates.wrapper(f)).appendTo(r).find("#"+u):t(f.control).appendTo(r),a.show_if&&n.on("input change",function(){l.closest(".form-group")[n.getVisiblityCondition(a.show_if)?"show":"hide"]()})}})}(i),n.find("[name]").each(function(){t(this).trigger("change")}),n},this.set=function(i){var e=this;e.find("[name]").each(function(){var n=e.getFieldValue(this.name,i);"undefined"!=typeof n&&t(this).val(n)})},this.toJSON=function(){var i=this,e=i.serializeArray(),n={};return t.each(e,function(){var e=this.name.split("-"),r=n,o=null,s=null,a=this.value;try{a=JSON.parse(a)}catch(u){}t.each(e,function(){s=this,o=r,r[this]||(r[this]={}),r=r[this]});var h=i.find("#"+this.name);h.attr("multiple")||"checkbox"===h.attr("type")?o[s].push?o[s].push(a):o[s]=[a]:o[s]=a}),n},this.onSubmit=function(e){var n=this,r=this.toJSON();n.find(".form-group.has-error").removeClass("has-error").tooltip("destroy");var o=[];return function s(i,e){t.each(i,function(t,i){var a=e?e+"-"+t:t,u=n.getFieldValue(a,r);if("group"===i.type)s(i.values,a);else if(i.required&&!u){if(i.show_if)for(var h in i.show_if)if(!n.getVisiblityCondition(i.show_if))return!0;o.push(n.find("#"+a))}})}(i),o.length?setTimeout(function(){o.reverse().map(n.throwError)},150):e.call(this,r),!1},this.throwError=function(t,i){var e=t.focus().closest(".form-group").addClass("has-error");"string"==typeof i&&e.tooltip({title:i,trigger:"manual"}).tooltip("show")},this.clear=function(){return this.off().find("*").remove(),this},this.getFieldValue=function(t,i){var e=t.split("-");return e.length>1?i?this.getFieldValue(e.slice(1).join("-"),i[e[0]]):void 0:i&&null!==i[t]?i[t]:void 0},this.getVisiblityCondition=function(t){return new Function("data","return "+t).call(this,this.toJSON())},this.clear().render(i,e).off("submit").on("submit",this.onSubmit.bind(this,n))}});
